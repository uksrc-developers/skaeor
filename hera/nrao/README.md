# NRAO tests

Before transferring data to UKSRC resources, tests were run on the NRAO system to verify the python environment built from the conda environment yaml `../environment.yaml`.  These tests are described in the following subsections.  More information is available on the [Generating H1C IDR3 power spectra on NRAO](https://confluence.skatelescope.org/display/SRCSC/Generating+H1C+IDR3+power+spectra+on+NRAO) confluence page.


## Run `hera_pspec`

In this test, JB ran `hera_pspec` on a subset of the full dataset used by HERA to ensure the python environment can run `hera_pspec` and generate the files that get fed into the notebook.  JB used a subset of the full HERA data (4 out of 20 files) for this test so the test would run more quickly.  JB also reduced the number of frequencies and baselines in the `hera_pspec` analysis to further reduce the runtime.  For this test the three files of interest in this directory are

- `pspec_params_LPXLTK.yaml`: yaml file containing file paths and analysis parameters for `hera_pspec`.  The changes made in this file to reduce the frequency and baseline axes are marked with in-line comments.
- `pspec_pipe.py`: python file which reads in the parameters in `pspec_params_LPXLTK.yaml` and runs `hera_pspec`
- `run_pspec_LPXLTK.sh`: Slurm sbatch script which calls `pspec_pipe.py`

These files were used to run `hera_pspec` on NRAO via the following steps:

1. Create a directory for the output from Slurm via
   ```
   mkdir slurm-out
   ```

2. Submit the sbatch script to Slurm via
   ```
   sbatch run_pspec_LPXLTK.sh
   ```

Please note that the file paths contained in the scripts used for this test are all defined relative to JB's lustre directories as data were temporarily copied/stored there for this test.  The data and directories should all be readable on NRAO, but they may not be writable.

Relevant compute info can be found in the table below.  The max RAM usage was obtained via Slurm's MaxRSS.

| Input data (GB) | CPUs | Max RAM (GB) | Duration (HH:MM:SS:) | Output data |
| --------------- | ---- | ------------ | -------------------- | ----------- |
| 6.4             | 10   | 4.92         | 07:58:46             | 6.7         |

The output files from `hera_pspec` are stored on NRAO at
```
/lustre/aoc/projects/hera/jburba/uksrc/hera/power-spectra/h1c-idr3/pspec/
```
The files generated within this directory are described in the table below.

| File Name | File Size | Description |
| --------- | --------- | ----------- |
| `pspec.grp1.of1.LPXLTK.h5` | 6.6 GB | `hera_pspec` HDF5 file containing per-baseline delay power spectra |
| `pspipe_out_LPXLTK.log` | 33 KB | Log file containing input parameter values and execution timing statements |
| `zen.grp1.of1.autos.Tsys.LPXLTK.uvh5` | 66 MB | `pyuvdata` file containing noise spectra (used to calculate power spectrum uncertainties) |


## Run the jupyter notebook

In this test, JB ran HERA's [H1C IDR3 power spectrum notebook](https://github.com/HERA-Team/H1C_IDR3_Power_Spectra/blob/main/SPOILERS/All_Epochs_Power_Spectra/H1C_IDR3_Power_Spectra.ipynb) on the full power spectrum dataset generated by HERA.  The output files from `hera_pspec` for the H1C IDR3 analysis are available on NRAO and do not need to be copied from cold storage.  The notebook run on NRAO for this test is stored in `H1C_IDR3_Power_Spectra.ipynb` in this directory.  This test verifies that the python environment has all of the dependencies required to form the final one-dimensional power spectrum estimate.


# UKSRC related links and information

**Confluence pages**

- [H1C IDR3 power spectrum pipeline](https://confluence.skatelescope.org/display/SRCSC/H1C+IDR3+power+spectrum+pipeline)
- [Generating H1C IDR3 power spectra on NRAO](https://confluence.skatelescope.org/display/SRCSC/Generating+H1C+IDR3+power+spectra+on+NRAO)

**Jira tickets**

- [TEAL-648](https://jira.skatelescope.org/browse/TEAL-648): python environment for HERA analysis on Socorro (continued)
- [TEAL-626](https://jira.skatelescope.org/browse/TEAL-626): Confluence page for HERA power spectrum pipeline code/steps
- [TEAL-628](https://jira.skatelescope.org/browse/TEAL-628): Run jupyter notebook to test environment
- [TEAL-629](https://jira.skatelescope.org/browse/TEAL-629): Run power spectrum pipeline (subset of data, at NRAO)
